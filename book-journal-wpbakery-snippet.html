<style>
.w4u-journal-section {
    width: 100%;
    min-height: 600px;
    height: 80vh;
    max-height: 900px;
    position: relative;
    background: transparent;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Inter', sans-serif;
}
.w4u-journal-section * { box-sizing: border-box; margin: 0; padding: 0; }

.w4u-journal-scene {
    perspective: 2500px;
    transform-origin: center center;
}

.w4u-journal-book {
    position: relative;
    width: 860px;
    height: 480px;
    transform-style: preserve-3d;
    transform: rotateX(8deg);
    display: flex;
}

.w4u-journal-book-shadow {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 40px;
    background: rgba(0,0,0,0.2);
    filter: blur(35px);
    border-radius: 10px;
    z-index: -1;
    transform: scaleY(0.1) translateY(400%);
}

.w4u-journal-book-left {
    width: 50%;
    height: 100%;
    position: relative;
    background: linear-gradient(to left, #e5ddd0 0%, #f2ebe0 100%);
    border-radius: 10px 0 0 10px;
    box-shadow: -3px 0 0 #d5cdc0, -6px 0 0 #c5bdb0;
    cursor: pointer;
    overflow: hidden;
}

.w4u-journal-book-left::after {
    content: '';
    position: absolute;
    right: 0;
    top: 6px;
    bottom: 6px;
    width: 12px;
    background: repeating-linear-gradient(180deg, #faf6f0 0px, #faf6f0 1px, #ddd5c8 1px, #ddd5c8 2px);
}

.w4u-journal-book-right {
    width: 50%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
}

.w4u-journal-book-right-base {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, #e5ddd0 0%, #f2ebe0 100%);
    border-radius: 0 10px 10px 0;
    box-shadow: 3px 0 0 #d5cdc0, 6px 0 0 #c5bdb0;
}

.w4u-journal-book-right-base::after {
    content: '';
    position: absolute;
    left: 0;
    top: 6px;
    bottom: 6px;
    width: 12px;
    background: repeating-linear-gradient(180deg, #faf6f0 0px, #faf6f0 1px, #ddd5c8 1px, #ddd5c8 2px);
}

.w4u-journal-spine {
    position: absolute;
    left: 50%;
    transform: translateX(-50%) translateZ(2px);
    width: 20px;
    height: 100%;
    background: linear-gradient(90deg, #7a6548 0%, #9a8568 30%, #a89578 50%, #9a8568 70%, #7a6548 100%);
    z-index: 50;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}

.w4u-journal-page {
    position: absolute;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    transform-origin: left center;
    cursor: pointer;
    user-select: none;
}

.w4u-journal-page-front, .w4u-journal-page-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    background: linear-gradient(to right, #eae4d8 0%, #f8f4ec 5%, #fdfbf8 100%);
    border-radius: 0 10px 10px 0;
    box-shadow: inset 5px 0 12px rgba(0,0,0,0.03);
    overflow: hidden;
}

.w4u-journal-page-back {
    transform: rotateY(180deg);
    background: linear-gradient(to left, #eae4d8 0%, #f8f4ec 5%, #fdfbf8 100%);
    border-radius: 10px 0 0 10px;
    box-shadow: inset -5px 0 12px rgba(0,0,0,0.03);
}

.w4u-journal-page-content {
    padding: 28px 32px;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.w4u-journal-drag-hint {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.02) 50%);
    pointer-events: none;
}

.w4u-journal-drag-hint-left {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 50px;
    height: 50px;
    background: linear-gradient(-135deg, transparent 50%, rgba(0,0,0,0.02) 50%);
    pointer-events: none;
}

.w4u-journal-cover .w4u-journal-page-front {
    background: #f5f3f0;
}

.w4u-journal-cover-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.w4u-journal-cover-front-layout {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 24px 32px;
    position: relative;
}

.w4u-journal-title-badge {
    background: #f5d230;
    padding: 8px 18px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 13px;
    color: #1a1a1a;
    align-self: flex-end;
}

.w4u-journal-cover-brand {
    margin-top: auto;
    margin-bottom: auto;
    padding-left: 20px;
}

.w4u-journal-cover-brand-name {
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: 42px;
    color: #3a3a3a;
    letter-spacing: -1px;
    line-height: 1;
}

.w4u-journal-cover-brand-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}

.w4u-journal-cube-logo {
    width: 64px;
    height: 64px;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.08));
}

.w4u-journal-cover-start-btn {
    background: #4a9e7e;
    color: white;
    font-family: 'Inter', sans-serif;
    font-weight: 600;
    font-size: 28px;
    padding: 10px 32px;
    border-radius: 30px;
    letter-spacing: 0.5px;
}

.w4u-journal-handwritten {
    font-family: 'Caveat', cursive;
    font-size: 19px;
    line-height: 1.55;
    color: #3a3530;
}

.w4u-journal-section-title {
    font-family: 'Playfair Display', serif;
    font-size: 19px;
    font-weight: 600;
    color: #2c2520;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #ddd0c0;
}

.w4u-journal-lined-bg {
    background-image: repeating-linear-gradient(transparent, transparent 25px, #e0d4c4 25px, #e0d4c4 26px);
    flex: 1;
}

.w4u-journal-quote-box {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border-left: 4px solid #f59e0b;
    padding: 14px 16px;
    margin: 10px 0;
    border-radius: 0 6px 6px 0;
    font-style: italic;
    font-size: 12px;
    line-height: 1.5;
    color: #4a4035;
}

.w4u-journal-checkbox-list {
    list-style: none;
}

.w4u-journal-checkbox-list li {
    display: flex;
    align-items: center;
    padding: 7px 0;
    border-bottom: 1px dashed #ddd0c0;
    font-size: 12px;
    color: #3a3530;
}

.w4u-journal-checkbox {
    width: 16px;
    height: 16px;
    border: 2px solid #a09585;
    border-radius: 3px;
    margin-right: 10px;
    flex-shrink: 0;
    position: relative;
}

.w4u-journal-checkbox.w4u-journal-checked {
    background: #22c55e;
    border-color: #16a34a;
}

.w4u-journal-checkbox.w4u-journal-checked::after {
    content: '';
    position: absolute;
    left: 4px;
    top: 1px;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.w4u-journal-date-badge {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 10px 16px;
    border-radius: 8px;
    text-align: center;
    display: inline-block;
    margin-bottom: 12px;
}

.w4u-journal-date-badge .w4u-journal-day { font-size: 22px; font-weight: 700; line-height: 1; }
.w4u-journal-date-badge .w4u-journal-month { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; }

.w4u-journal-mood-row {
    display: flex;
    gap: 6px;
    margin: 8px 0;
}

.w4u-journal-mood-item {
    flex: 1;
    text-align: center;
    padding: 8px 4px;
    background: #faf6f0;
    border-radius: 6px;
    font-size: 18px;
    border: 2px solid transparent;
}

.w4u-journal-mood-item.w4u-journal-active {
    background: #fef3c7;
    border-color: #fbbf24;
}

.w4u-journal-mood-item span {
    display: block;
    font-size: 8px;
    color: #6b5b4f;
    margin-top: 2px;
    text-transform: uppercase;
}

.w4u-journal-progress-bar {
    height: 5px;
    background: #e8e0d4;
    border-radius: 3px;
    margin-top: 5px;
    overflow: hidden;
}

.w4u-journal-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    border-radius: 3px;
}

.w4u-journal-highlight {
    background: linear-gradient(180deg, transparent 55%, #fef08a 55%);
}

.w4u-journal-page-num {
    position: absolute;
    bottom: 12px;
    font-size: 10px;
    color: #a09585;
}

.w4u-journal-page-front .w4u-journal-page-num { right: 24px; }
.w4u-journal-page-back .w4u-journal-page-num { left: 24px; }

.w4u-journal-controls {
    position: absolute;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 100;
}

.w4u-journal-nav-btn {
    width: 42px;
    height: 42px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 3px 12px rgba(0,0,0,0.12);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

.w4u-journal-nav-btn:hover { transform: scale(1.1); }
.w4u-journal-nav-btn:active { transform: scale(0.95); }
.w4u-journal-nav-btn svg { width: 18px; height: 18px; fill: #5a4a3a; }

.w4u-journal-page-info {
    background: rgba(255,255,255,0.9);
    padding: 7px 16px;
    border-radius: 18px;
    font-size: 12px;
    color: #5a4a3a;
}

.w4u-journal-hint {
    position: absolute;
    top: 22px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.5);
    color: white;
    padding: 9px 20px;
    border-radius: 20px;
    font-size: 12px;
    animation: w4uJournalFadeHint 4s ease 0.5s forwards;
    opacity: 0;
    z-index: 100;
}

@keyframes w4uJournalFadeHint {
    0%, 100% { opacity: 0; }
    15%, 85% { opacity: 1; }
}

@media (max-width: 900px) {
    .w4u-journal-controls { bottom: 15px; gap: 8px; }
    .w4u-journal-nav-btn { width: 38px; height: 38px; }
    .w4u-journal-page-info { font-size: 11px; padding: 6px 12px; }
    .w4u-journal-hint { font-size: 11px; padding: 7px 16px; top: 12px; }
}

@media (max-width: 600px) {
    .w4u-journal-section { min-height: 400px; height: 55vh; max-height: 500px; }
    .w4u-journal-controls { bottom: 10px; gap: 6px; }
    .w4u-journal-nav-btn { width: 34px; height: 34px; }
    .w4u-journal-nav-btn svg { width: 15px; height: 15px; }
    .w4u-journal-page-info { font-size: 10px; padding: 5px 10px; }
    .w4u-journal-hint { font-size: 10px; padding: 6px 14px; top: 8px; white-space: nowrap; }
}
</style>

<div class="w4u-journal-section" id="w4u-journal-section">
    <div class="w4u-journal-hint">Click or drag pages to flip</div>

    <div class="w4u-journal-scene" id="w4u-journal-scene">
        <div class="w4u-journal-book" id="w4u-journal-book">
            <div class="w4u-journal-book-shadow"></div>

            <div class="w4u-journal-book-left" id="w4u-journal-book-left">
                <div class="w4u-journal-book-left-base"></div>
                <div class="w4u-journal-drag-hint-left"></div>
            </div>

            <div class="w4u-journal-spine"></div>

            <div class="w4u-journal-book-right" id="w4u-journal-book-right">
                <div class="w4u-journal-book-right-base"></div>

                <div class="w4u-journal-page" data-page="4">
                    <div class="w4u-journal-page-front">
                        <div class="w4u-journal-page-content">
                            <div class="w4u-journal-cover-content">
                                <div style="text-align: center; color: #6b5b4f; font-family: 'Playfair Display', serif; font-style: italic; font-size: 18px;">Keep Writing.<br>Keep Growing.</div>
                                <div style="margin-top: 20px; font-size: 11px; color: #a09585;">The End</div>
                            </div>
                        </div>
                        <div class="w4u-journal-drag-hint"></div>
                    </div>
                    <div class="w4u-journal-page-back">
                        <div class="w4u-journal-page-content">
                            <h2 class="w4u-journal-section-title">Notes</h2>
                            <div class="w4u-journal-handwritten w4u-journal-lined-bg">Space for your additional thoughts...</div>
                            <span class="w4u-journal-page-num">7</span>
                        </div>
                        <div class="w4u-journal-drag-hint-left"></div>
                    </div>
                </div>

                <div class="w4u-journal-page" data-page="3">
                    <div class="w4u-journal-page-front">
                        <div class="w4u-journal-page-content">
                            <h2 class="w4u-journal-section-title">Weekly Review</h2>
                            <div class="w4u-journal-handwritten w4u-journal-lined-bg">
                                <strong style="font-family: Inter; font-size: 11px;">What went well:</strong><br>Completed all tasks<br><br>
                                <strong style="font-family: Inter; font-size: 11px;">To improve:</strong><br>Morning routine<br><br>
                                <strong style="font-family: Inter; font-size: 11px;">Next week:</strong><br>Start new project
                            </div>
                            <span class="w4u-journal-page-num">6</span>
                        </div>
                        <div class="w4u-journal-drag-hint"></div>
                    </div>
                    <div class="w4u-journal-page-back">
                        <div class="w4u-journal-page-content">
                            <h2 class="w4u-journal-section-title">Ideas & Dreams</h2>
                            <div class="w4u-journal-quote-box" style="border-color: #6366f1; background: linear-gradient(135deg, #eef2ff, #e0e7ff);">"Creativity is intelligence having fun."</div>
                            <div class="w4u-journal-handwritten w4u-journal-lined-bg">- Learn watercolor painting<br><br>- Write a short story<br><br>- Create a vision board</div>
                            <span class="w4u-journal-page-num">5</span>
                        </div>
                        <div class="w4u-journal-drag-hint-left"></div>
                    </div>
                </div>

                <div class="w4u-journal-page" data-page="2">
                    <div class="w4u-journal-page-front">
                        <div class="w4u-journal-page-content">
                            <h2 class="w4u-journal-section-title">Gratitude List</h2>
                            <div class="w4u-journal-handwritten w4u-journal-lined-bg">1. My supportive family<br><br>2. Good health<br><br>3. Learning opportunities<br><br>4. Morning coffee<br><br>5. Beautiful sunsets</div>
                            <span class="w4u-journal-page-num">4</span>
                        </div>
                        <div class="w4u-journal-drag-hint"></div>
                    </div>
                    <div class="w4u-journal-page-back">
                        <div class="w4u-journal-page-content">
                            <div class="w4u-journal-date-badge"><div class="w4u-journal-day">15</div><div class="w4u-journal-month">January</div></div>
                            <div class="w4u-journal-mood-row">
                                <div class="w4u-journal-mood-item">:)<span>Happy</span></div>
                                <div class="w4u-journal-mood-item w4u-journal-active">:D<span>Great</span></div>
                                <div class="w4u-journal-mood-item">:|<span>Okay</span></div>
                                <div class="w4u-journal-mood-item">:(<span>Low</span></div>
                            </div>
                            <div class="w4u-journal-handwritten w4u-journal-lined-bg">Today was <span class="w4u-journal-highlight">wonderful</span>!<br><br>Finally finished the project.</div>
                            <span class="w4u-journal-page-num">3</span>
                        </div>
                        <div class="w4u-journal-drag-hint-left"></div>
                    </div>
                </div>

                <div class="w4u-journal-page" data-page="1">
                    <div class="w4u-journal-page-front">
                        <div class="w4u-journal-page-content">
                            <h2 class="w4u-journal-section-title">Monthly Goals</h2>
                            <ul class="w4u-journal-checkbox-list">
                                <li><span class="w4u-journal-checkbox w4u-journal-checked"></span>Start morning meditation</li>
                                <li><span class="w4u-journal-checkbox w4u-journal-checked"></span>Read 2 books</li>
                                <li><span class="w4u-journal-checkbox"></span>Complete online course</li>
                                <li><span class="w4u-journal-checkbox"></span>Practice gratitude daily</li>
                                <li><span class="w4u-journal-checkbox"></span>Exercise 3x per week</li>
                            </ul>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #6b5b4f;"><span>Progress</span><span>40%</span></div>
                                <div class="w4u-journal-progress-bar"><div class="w4u-journal-progress-fill" style="width: 40%"></div></div>
                            </div>
                            <span class="w4u-journal-page-num">2</span>
                        </div>
                        <div class="w4u-journal-drag-hint"></div>
                    </div>
                    <div class="w4u-journal-page-back">
                        <div class="w4u-journal-page-content">
                            <h2 class="w4u-journal-section-title">Welcome</h2>
                            <div class="w4u-journal-quote-box">"The journey of a thousand miles begins with a single step." - Lao Tzu</div>
                            <div class="w4u-journal-handwritten w4u-journal-lined-bg">This journal belongs to you.<br><br>Use it to capture your thoughts and reflections.</div>
                            <span class="w4u-journal-page-num">1</span>
                        </div>
                        <div class="w4u-journal-drag-hint-left"></div>
                    </div>
                </div>

                <div class="w4u-journal-page w4u-journal-cover" data-page="0">
                    <div class="w4u-journal-page-front">
                        <div class="w4u-journal-cover-front-layout">
                            <div class="w4u-journal-title-badge">My Reflection Journal</div>
                            <div class="w4u-journal-cover-brand">
                                <div class="w4u-journal-cover-brand-name">Well4U</div>
                                <div class="w4u-journal-cover-brand-row">
                                    <svg class="w4u-journal-cube-logo" viewBox="0 0 100 100">
                                        <polygon points="50,5 93,28 93,72 50,95 7,72 7,28" fill="none"/>
                                        <polygon points="50,5 93,28 50,50 7,28" fill="#6b5b95"/>
                                        <polygon points="7,28 50,50 50,95 7,72" fill="#45b5aa"/>
                                        <polygon points="93,28 50,50 50,95 93,72" fill="#e8654a"/>
                                        <polygon points="50,30 72,42 72,64 50,76 28,64 28,42" fill="#f5c842"/>
                                        <polygon points="28,42 50,54 50,76 28,64" fill="#e8941a"/>
                                        <polygon points="50,30 72,42 50,54 28,42" fill="#7b6ba5"/>
                                        <polygon points="72,42 50,54 50,76 72,64" fill="#45b5aa"/>
                                    </svg>
                                    <div class="w4u-journal-cover-start-btn">Start</div>
                                </div>
                            </div>
                        </div>
                        <div class="w4u-journal-drag-hint"></div>
                    </div>
                    <div class="w4u-journal-page-back">
                        <div class="w4u-journal-page-content">
                            <div class="w4u-journal-cover-content">
                                <span style="color: #bbb; font-size: 12px;">Inside Cover</span>
                            </div>
                        </div>
                        <div class="w4u-journal-drag-hint-left"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="w4u-journal-controls">
        <button class="w4u-journal-nav-btn" id="w4u-journal-prev-btn"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
        <div class="w4u-journal-page-info">Page <span id="w4u-journal-current-page">Cover</span></div>
        <button class="w4u-journal-nav-btn" id="w4u-journal-next-btn"><svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg></button>
    </div>
</div>

<script>
(function() {
    'use strict';

    // Load fonts
    var fontLink = document.createElement('link');
    fontLink.href = 'https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap';
    fontLink.rel = 'stylesheet';
    document.head.appendChild(fontLink);

    // Load GSAP
    function loadGSAP(callback) {
        if (typeof gsap !== 'undefined') { callback(); return; }
        var script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js';
        script.onload = callback;
        script.onerror = function() {
            console.log('Failed to load GSAP library.');
        };
        document.head.appendChild(script);
    }

    function initJournal() {
        var section = document.getElementById('w4u-journal-section');
        if (!section) return;

        var pages = Array.from(section.querySelectorAll('.w4u-journal-page'));
        var bookRight = document.getElementById('w4u-journal-book-right');
        var bookLeft = document.getElementById('w4u-journal-book-left');
        var totalPages = pages.length;

        var currentIdx = 0;
        var isFlipping = false;
        var dragStartX = 0;
        var isDragging = false;
        var dragPage = null;
        var dragDir = null;

        function initPages() {
            pages.forEach(function(p) {
                var pageNum = +p.dataset.page;
                gsap.set(p, {
                    zIndex: 50 + (totalPages - pageNum),
                    rotationY: 0
                });
            });
        }

        function updateInfo() {
            var labels = ['Cover', '1-2', '3-4', '5-6', '7-End'];
            var el = document.getElementById('w4u-journal-current-page');
            if (el) el.textContent = labels[currentIdx] || '';
        }

        function getTopPage() {
            return pages.find(function(p) { return +p.dataset.page === currentIdx; });
        }

        function getLastFlippedPage() {
            if (currentIdx <= 0) return null;
            return pages.find(function(p) { return +p.dataset.page === currentIdx - 1; });
        }

        function flipForward(fromDrag) {
            if (isFlipping || currentIdx >= totalPages) return;

            var page = getTopPage();
            if (!page) return;

            isFlipping = true;
            gsap.set(page, { zIndex: 100 });

            gsap.to(page, {
                rotationY: -180,
                duration: fromDrag ? 0.5 : 0.6,
                ease: 'power2.inOut',
                onComplete: function() {
                    gsap.set(page, { zIndex: currentIdx + 1 });
                    currentIdx++;
                    updateInfo();
                    isFlipping = false;
                }
            });
        }

        function flipBack(fromDrag) {
            if (isFlipping || currentIdx <= 0) return;

            var page = getLastFlippedPage();
            if (!page) return;

            isFlipping = true;
            gsap.set(page, { zIndex: 100 });

            gsap.to(page, {
                rotationY: 0,
                duration: fromDrag ? 0.35 : 0.6,
                ease: 'power2.inOut',
                onComplete: function() {
                    currentIdx--;
                    gsap.set(page, { zIndex: 50 + (totalPages - currentIdx) });
                    updateInfo();
                    isFlipping = false;
                }
            });
        }

        // Responsive scaling
        var scene = document.getElementById('w4u-journal-scene');
        var currentScale = 1;

        function resizeBook() {
            var sectionRect = section.getBoundingClientRect();
            var vw = sectionRect.width;
            var vh = sectionRect.height;
            var bookWidth = 860;
            var bookHeight = 480;
            var controlsSpace = 70;

            var scaleX = (vw * 0.95) / bookWidth;
            var scaleY = ((vh - controlsSpace) * 0.9) / bookHeight;
            currentScale = Math.min(scaleX, scaleY, 1);

            scene.style.transform = 'scale(' + currentScale + ')';
        }

        // Drag handlers
        var book = section.querySelector('.w4u-journal-book');

        function getDragDirection(clientX) {
            var bookRect = book.getBoundingClientRect();
            var bookCenterX = bookRect.left + bookRect.width / 2;
            return clientX < bookCenterX ? 'back' : 'forward';
        }

        function startDrag(e, dir) {
            if (isFlipping) return;
            if (dir === 'forward' && currentIdx >= totalPages) return;
            if (dir === 'back' && currentIdx <= 0) return;

            var clientX = e.touches ? e.touches[0].clientX : e.clientX;
            dragStartX = clientX;
            isDragging = true;
            dragDir = dir;

            if (dir === 'forward') {
                dragPage = getTopPage();
            } else {
                dragPage = getLastFlippedPage();
            }

            if (dragPage) {
                gsap.set(dragPage, { zIndex: 100 });
            }

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }

        function onDrag(e) {
            if (!isDragging || !dragPage) return;
            e.preventDefault();

            var clientX = e.touches ? e.touches[0].clientX : e.clientX;
            var delta = dragStartX - clientX;

            if (dragDir === 'forward') {
                var dragRange = 500 * currentScale;
                var progress = Math.max(0, Math.min(1, delta / dragRange));
                gsap.set(dragPage, { rotationY: -180 * progress });
            } else {
                var dragRange = 500 * currentScale;
                var progress = Math.max(0, Math.min(1, -delta / dragRange));
                gsap.set(dragPage, { rotationY: -180 + (180 * progress) });
            }
        }

        function endDrag(e) {
            if (!isDragging) return;

            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', endDrag);

            var clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            var delta = dragStartX - clientX;
            var threshold = 80 * currentScale;

            isDragging = false;

            if (!dragPage) {
                dragDir = null;
                return;
            }

            if (dragDir === 'forward') {
                if (delta > threshold) {
                    flipForward(true);
                } else {
                    gsap.to(dragPage, {
                        rotationY: 0,
                        duration: 0.35,
                        ease: 'power2.out',
                        onComplete: function() {
                            gsap.set(dragPage, { zIndex: 50 + (totalPages - currentIdx) });
                        }
                    });
                }
            } else {
                if (-delta > threshold) {
                    flipBack(true);
                } else {
                    gsap.to(dragPage, {
                        rotationY: -180,
                        duration: 0.35,
                        ease: 'power2.out',
                        onComplete: function() {
                            gsap.set(dragPage, { zIndex: currentIdx });
                        }
                    });
                }
            }

            dragPage = null;
            dragDir = null;
        }

        function handleBookRightMouseDown(e) {
            if (!e.target.closest('.w4u-journal-page')) return;
            var clientX = e.touches ? e.touches[0].clientX : e.clientX;
            var dir = getDragDirection(clientX);
            startDrag(e, dir);
        }

        bookRight.addEventListener('mousedown', handleBookRightMouseDown);
        bookRight.addEventListener('touchstart', handleBookRightMouseDown, { passive: false });

        bookLeft.addEventListener('mousedown', function(e) { startDrag(e, 'back'); });
        bookLeft.addEventListener('touchstart', function(e) { startDrag(e, 'back'); }, { passive: false });

        function handlePageClick(e) {
            if (isFlipping || isDragging) return;

            var clientX = e.clientX;
            var dir = getDragDirection(clientX);

            var page = e.target.closest('.w4u-journal-page');
            if (!page) return;

            if (dir === 'forward') {
                var pageNum = +page.dataset.page;
                if (pageNum === currentIdx) {
                    e.stopPropagation();
                    flipForward();
                }
            } else {
                var pageNum = +page.dataset.page;
                if (pageNum === currentIdx - 1) {
                    e.stopPropagation();
                    flipBack();
                }
            }
        }

        bookRight.addEventListener('click', handlePageClick);

        bookLeft.addEventListener('click', function(e) {
            if (isFlipping || isDragging) return;
            if (currentIdx > 0) flipBack();
        });

        // Nav buttons
        document.getElementById('w4u-journal-next-btn').addEventListener('click', function() { flipForward(); });
        document.getElementById('w4u-journal-prev-btn').addEventListener('click', function() { flipBack(); });

        // Keyboard
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight') flipForward();
            if (e.key === 'ArrowLeft') flipBack();
        });

        window.addEventListener('resize', resizeBook);

        // Initialize
        initPages();
        updateInfo();
        resizeBook();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            loadGSAP(initJournal);
        });
    } else {
        loadGSAP(initJournal);
    }
})();
</script>
